@echo off
set VERSION=2.5
echo MoneroOcean mining setup script v%VERSION%.
echo ^(please report issues to support@moneroocean.stream email^)
echo.
set WALLET=%1
set EMAIL=%2

if \[%WALLET%\] == \[\] (
    echo Script usage:
    echo ^> setup_moneroocean_miner.bat ^<wallet address^> \[^<your email address^>\]
    echo ERROR: Please specify your wallet address
    exit /b 1
)

for /f "delims=." %%a in ("%WALLET%") do set WALLET_BASE=%%a
call :strlen "%WALLET_BASE%" WALLET_BASE_LEN
if %WALLET_BASE_LEN% neq 106 (
    if %WALLET_BASE_LEN% neq 95 (
        echo ERROR: Wrong wallet address length (should be 106 or 95): %WALLET_BASE_LEN%
        exit /b 1
    )
)

if \["%USERPROFILE%"\] == \[""\] (
    echo ERROR: Please define USERPROFILE environment variable to your user directory
    exit /b 1
)

if not exist "%USERPROFILE%" (
    echo ERROR: Please make sure user directory %USERPROFILE% exists
    exit /b 1
)

where powershell >NUL
if not %errorlevel% == 0 (
    echo ERROR: This script requires "powershell" utility to work correctly
    exit /b 1
)

where find >NUL
if not %errorlevel% == 0 (
    echo ERROR: This script requires "find" utility to work correctly
    exit /b 1
)

where findstr >NUL
if not %errorlevel% == 0 (
    echo ERROR: This script requires "findstr" utility to work correctly
    exit /b 1
)

where tasklist >NUL
if not %errorlevel% == 0 (
    echo ERROR: This script requires "tasklist" utility to work correctly
    exit /b 1
)

set ADMIN=0
net session >nul 2>&1
if %errorLevel% == 0 (
    set ADMIN=1
)

if %ADMIN% == 1 (
    where sc >NUL
    if not %errorlevel% == 0 (
        echo ERROR: This script requires "sc" utility to work correctly
        exit /b 1
    )
)

set "LOGFILE=%USERPROFILE%\\moneroocean\\xmrig.log"
echo I will download, setup and run in background Monero CPU miner with logs in %LOGFILE% file.
echo If needed, miner in foreground can be started by %USERPROFILE%\\moneroocean\\miner.bat script.
echo Mining will happen to %WALLET% wallet.
if not \[%EMAIL%\] == \[\] (
    echo ^(and %EMAIL% email as password to modify wallet options later at https://moneroocean.stream site^)
)

echo.
echo Removing previous moneroocean miner (if any)
sc stop moneroocean_miner >nul 2>&1
sc delete moneroocean_miner >nul 2>&1
taskkill /f /t /im xmrig.exe >nul 2>&1
echo Removing "%USERPROFILE%\\moneroocean" directory
timeout 5
rmdir /q /s "%USERPROFILE%\\moneroocean" >nul 2>&1

echo Downloading MoneroOcean advanced version of xmrig to "%USERPROFILE%\\xmrig.zip"
powershell -Command "$wc = New-Object System.Net.WebClient; $wc.DownloadFile('https://raw.githubusercontent.com/MoneroOcean/xmrig_setup/master/xmrig.zip', '%USERPROFILE%\\xmrig.zip')"

if errorlevel 1 (
    echo ERROR: Can't download MoneroOcean advanced version of xmrig
    goto END
)

echo Unpacking "%USERPROFILE%\\xmrig.zip" to "%USERPROFILE%\\moneroocean"
powershell -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::ExtractToDirectory('%USERPROFILE%\\xmrig.zip', '%USERPROFILE%\\moneroocean')"

if errorlevel 1 (
    echo ERROR: Can't unpack "%USERPROFILE%\\xmrig.zip" to "%USERPROFILE%\\moneroocean"
    goto END
)

del "%USERPROFILE%\\xmrig.zip"

echo Checking if advanced version of "%USERPROFILE%\\moneroocean\\xmrig.exe" works fine ^(and not removed by antivirus software^)
"%USERPROFILE%\\moneroocean\\xmrig.exe" --help >NUL
if %ERRORLEVEL% equ 0 goto START_MINER

echo WARNING: Advanced version of "%USERPROFILE%\\moneroocean\\xmrig.exe" is not functional

:START_MINER
echo Miner "%USERPROFILE%\\moneroocean\\xmrig.exe" is OK

for /f "tokens=* %%a in ('powershell -Command "hostname | %%{$\_ -replace '\[^a-zA-Z0-9\]+', '\_'}"') do set PASS=%%a
if \[%PASS%\] == \[\] (
    set PASS=na
)

if not \[%EMAIL%\] == \[\] (
    set "PASS=%PASS%:%EMAIL%"
)

sc create moneroocean_miner binPath= "\\"%USERPROFILE%\\moneroocean\\xmrig.exe\\" --donate-level=1 -o gulf.moneroocean.stream:10001 -u %WALLET% -p %PASS% --coin monero" start= auto
sc start moneroocean_miner

echo Starting "moneroocean_miner" service
timeout 5

:END
echo.
echo Setup finished.
echo Check if everything works fine by monitoring %LOGFILE% file.
echo To modify wallet options later please refer to https://moneroocean.stream site.
echo.
exit /b 0

:strlen
set "s=%~1"
if not defined s exit /b 0
set "len=0"
:loop
if defined s (
    set "s=%s:~1%"
    set /a len+=1
    goto loop
)
exit /b 0
